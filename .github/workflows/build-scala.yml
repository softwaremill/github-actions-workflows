name: build

on:
  workflow_call:
    inputs:
      java-version:
        required: true
        type: string
      java-opts:
        required: false
        type: string
        default: ""
      sttp-native:
        required: false
        type: number
        default: 0
      install-libidn11:
        required: false
        type: boolean
        default: false
      install-libidn2:
        required: false
        type: boolean
        default: false

jobs:
  ci:
    runs-on: ubuntu-20.04
    env:
      JAVA_OPTS: ${{ inputs.java-opts }}
      STTP_NATIVE: ${{inputs.sttp-native}}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{inputs.java-version}}
        cache: 'sbt'
    - name: Cache sbt
      uses: actions/cache@v2
      with:
        path: |
          ~/.sbt
          ~/.ivy2/cache
          ~/.coursier
        key: sbt-cache-${{ runner.os }}-${{ hashFiles('project/build.properties') }}
    - name: Install libidn11-dev
      if: ${{ inputs.install-libidn11 }}
      run: sudo apt-get install libidn11-dev
    - name: Install libidn2-dev
      if: ${{ inputs.install-libidn2 }}
      run: |
        sudo apt-get update
        sudo apt-get install libidn2-dev
    - name: Compile
      run: sbt -v compile
    - name: Test
      run: sbt -v test
    - name: Cleanup
      run: |
        rm -rf "$HOME/.ivy2/local" || true
        find $HOME/.ivy2/cache                       -name "ivydata-*.properties" -delete || true
        find $HOME/.ivy2/cache                       -name "*-LM-SNAPSHOT*"       -delete || true
        find $HOME/.cache/coursier/v1                -name "ivydata-*.properties" -delete || true
        find $HOME/.sbt                              -name "*.lock"               -delete || true
